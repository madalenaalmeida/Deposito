<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel de Administração</title>
  <!-- Carrega o CSS global e o admin.css (sem alterações) -->
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="admin-style.css">
  
<body>

  <div class="container">
    <!-- Navbar com botão para abrir o menu lateral -->
    <nav>
      <div class="menu-btn" id="menu-btn"><i class="fas fa-bars"></i></div>
    </nav>

    <!-- Menu lateral (Sidebar) -->
    <div class="sidebar" id="sidebar">
      <div class="overlay" id="overlay"></div>
      <ul>
        <li><a href="index.html">Início</a></li>
        <li><a href="ramo-avezinha.html">Ramo Avezinha</a></li>
        <li><a href="ramo-aventura.html">Ramo Aventura</a></li>
        <li><a href="ramo-caravela.html">Ramo Caravela</a></li>
        <li><a href="ramo-moinho.html">Ramo Moinho</a></li>
        <li><a href="dirigentes.html">Dirigentes</a></li>
        <li><a href="faq.html">Questões Frequentes</a></li>
        <li><a href="login.html">Área Administrativa</a></li>
      </ul>
    </div>

    <!-- Header com imagem de fundo e texto centralizado -->
    <header>
      <h1>Bem-vindo ao Depósito - Escolhe o teu ramo para começar!</h1>
    </header>
  

 

    <!-- Tabelas -->
    <section id="admin-detalhados">
      <h2>Pedidos detalhados (todos)</h2>
      <div class="table-actions" style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0;">
        <button type="button" id="exp-detalhados-csv" style="display:inline-block;width:auto;">Exportar CSV</button>
        <button type="button" id="exp-detalhados-xlsx" style="display:inline-block;width:auto;">Exportar Excel</button>
      </div>
      <table id="admin-detalhados-table">
        <thead>
          <tr>
            <th>Nome</th><th>Email</th><th>Ramo</th><th>Produto</th><th>Tamanho</th><th>Qtd</th><th>Preço unit.</th><th>Total</th><th>Data</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="admin-por-ramo">
      <h2>Pedidos por ramo (agregado)</h2>
      <div class="table-actions" style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0;">
        <button type="button" id="exp-porramo-csv" style="display:inline-block;width:auto;">Exportar CSV</button>
        <button type="button" id="exp-porramo-xlsx" style="display:inline-block;width:auto;">Exportar Excel</button>
      </div>
      <table id="admin-por-ramo-table">
        <thead>
          <tr>
            <th>Ramo</th><th>Produto</th><th>Tamanho</th><th>Quantidade</th><th>Preço (total)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="admin-por-ramo-detalhes">
      <h2>Por ramo — detalhes</h2>
      <!-- ações e tabelas vão sendo geradas por JS para cada ramo -->
    </section>
  </main>
  <div class="date-filter">
    <div>
      <label for="start-date">De</label>
      <input type="date" id="start-date">
    </div>
    <div>
      <label for="end-date">Até</label>
      <input type="date" id="end-date">
    </div>
    <button class="apply-btn" onclick="aplicarFiltro()">Aplicar filtro</button>
    <button class="clear-btn" onclick="limparFiltro()">Limpar</button>
  </div>
  
  <!-- Toggle simples do menu mobile (não traz lógica do carrinho) -->
  <script>
    const menuBtn = document.getElementById('menu-btn');
    const nav = document.querySelector('.navbar');
    if (menuBtn && nav) {
      menuBtn.addEventListener('click', () => {
        nav.classList.toggle('active');
      });
    }
  </script>

  <!-- Lógica Admin -->
  <script>
  const parseMaybeNumber = (v) => {
    if (typeof v === 'number') return v;
    if (v == null) return 0;
    const n = Number(String(v).replace(',', '.'));
    return isNaN(n) ? 0 : n;
  };
  const money = (n) => (Math.round(n*100)/100).toFixed(2).replace('.', ',') + '€';
  const norm = (p) => ({
    nome: p.nome || p.name || '',
    email: p.email || '',
    ramo: p.ramo || p.branch || '',
    produto: p.produto || p.product || '',
    tamanho: p.tamanho || p.size || '',
    quantidade: parseMaybeNumber(p.quantidade != null ? p.quantidade : p.quantity),
    precoUnit: parseMaybeNumber(p.preco != null ? p.preco : p.price),
    total: parseMaybeNumber(p.preco != null ? p.preco : p.price) * parseMaybeNumber(p.quantidade != null ? p.quantidade : p.quantity),
    data: p.data || p.timestamp || ''
  });
  const getPedidos = () => {
    try { const arr = JSON.parse(localStorage.getItem('pedidos')) || []; return Array.isArray(arr)?arr.map(norm):[]; }
    catch(e){ return []; }
  };
  const filtrarPorData = (arr, ini, fim) => {
    if (!ini && !fim) return arr;
    const i = ini ? new Date(ini) : null;
    const f = fim ? new Date(fim) : null;
    return arr.filter(p => {
      if (!p.data) return true;
      const d = new Date(p.data);
      if (i && d < i) return false;
      if (f && d > f) return false;
      return true;
    });
  };
  const agrupar = (arr, keyFn) => {
    const map = new Map();
    for (const p of arr) {
      const k = keyFn(p);
      const rec = map.get(k) || { quantidade: 0, total: 0, sample: p };
      rec.quantidade += p.quantidade || 0;
      rec.total += p.total || 0;
      map.set(k, rec);
    }
    return Array.from(map.entries()).map(([key, v]) => ({ key, ...v }));
  };
  function toCSV(table){
    const rows = Array.from(table.querySelectorAll('tr')).map(tr =>
      Array.from(tr.querySelectorAll('th,td')).map(td => {
        let txt = (td.innerText||'').replace(/\r?\n|\r/g, ' ').trim();
        if (/[",;\n]/.test(txt)) txt = '"' + txt.replace(/"/g, '""') + '"';
        return txt;
      }).join(';')
    );
    return rows.join('\n');
  }
  function downloadBlob(content, filename, mime){
    const blob = new Blob([content], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }
  function exportCSV(table, title){
    const name = (title||'tabela').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') + '_' + new Date().toISOString().slice(0,10) + '.csv';
    downloadBlob(toCSV(table), name, 'text/csv;charset=utf-8;');
  }
  function exportXLSX(table, title){
    if (typeof XLSX === 'undefined' || !XLSX?.utils?.table_to_book) {
      alert('Para exportar em Excel (.xlsx), mantém a biblioteca XLSX incluída no <head>.');
      return;
    }
    const wb = XLSX.utils.table_to_book(table, {sheet: (title||'TABELA').slice(0,31)});
    const name = (title||'tabela').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') + '_' + new Date().toISOString().slice(0,10) + '.xlsx';
    XLSX.writeFile(wb, name);
  }

  function bindExports(sectionId, tableId, titleText){
    const tbl = document.getElementById(tableId);
    document.getElementById(sectionId).querySelector('#exp-'+sectionId.split('admin-')[1]+'-csv')?.addEventListener('click', ()=> exportCSV(tbl, titleText));
    document.getElementById(sectionId).querySelector('#exp-'+sectionId.split('admin-')[1]+'-xlsx')?.addEventListener('click', ()=> exportXLSX(tbl, titleText));
  }

  function render(){
    const ini = document.getElementById('filtro-inicio')?.value || '';
    const fim = document.getElementById('filtro-fim')?.value || '';
    const pedidos = filtrarPorData(getPedidos(), ini, fim);

    // Resumo
    const totalQtd = pedidos.reduce((s,p)=>s+(p.quantidade||0),0);
    const totalVal = pedidos.reduce((s,p)=>s+(p.total||0),0);
    const resumo = document.getElementById('admin-resumo');
    if (resumo) resumo.innerHTML = `<b>${pedidos.length}</b> registos | Qtde: <b>${totalQtd}</b> | Valor: <b>${money(totalVal)}</b>`;

    // 1) Detalhados
    const tbDetalhe = document.querySelector('#admin-detalhados-table tbody');
    tbDetalhe.innerHTML = '';
    pedidos.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.nome}</td>
        <td>${p.email}</td>
        <td>${p.ramo}</td>
        <td>${p.produto}</td>
        <td>${p.tamanho}</td>
        <td>${p.quantidade||0}</td>
        <td>${money(p.precoUnit)}</td>
        <td>${money(p.total)}</td>
        <td>${p.data||''}</td>
      `;
      tbDetalhe.appendChild(tr);
    });

    // 2) Por ramo (agregado)
    const grupos = agrupar(pedidos, p => [p.ramo, p.produto, p.tamanho].join(' | '));
    const tbRamo = document.querySelector('#admin-por-ramo-table tbody');
    tbRamo.innerHTML = '';
    grupos.forEach(g => {
      const [ramo, produto, tamanho] = g.key.split(' | ');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${ramo}</td>
        <td>${produto}</td>
        <td>${tamanho}</td>
        <td>${g.quantidade}</td>
        <td>${money(g.total)}</td>
      `;
      tbRamo.appendChild(tr);
    });

    // 3) Uma tabela por ramo (detalhada)
    const secRamos = document.getElementById('admin-por-ramo-detalhes');
    Array.from(secRamos.querySelectorAll('table, .ramo-title')).forEach(n => n.remove());
    const rams = Array.from(new Set(pedidos.map(p => p.ramo))).filter(Boolean);
    rams.forEach(ramo => {
      const h = document.createElement('div');
      h.className = 'ramo-title';
      h.textContent = ramo;
      secRamos.appendChild(h);

      // Barra de ações por ramo (inline styles para não depender de CSS)
      const bar = document.createElement('div');
      bar.className = 'table-actions';
      bar.style.cssText = 'display:flex;gap:8px;flex-wrap:wrap;margin:6px 0;';
      const b1 = document.createElement('button'); b1.type='button'; b1.textContent='Exportar CSV'; b1.style.cssText='display:inline-block;width:auto;';
      const b2 = document.createElement('button'); b2.type='button'; b2.textContent='Exportar Excel'; b2.style.cssText='display:inline-block;width:auto;';
      bar.appendChild(b1); bar.appendChild(b2);
      secRamos.appendChild(bar);

      const tbl = document.createElement('table');
      tbl.innerHTML = `<thead><tr>
        <th>Nome</th><th>Email</th><th>Produto</th><th>Tamanho</th><th>Qtd</th><th>Preço unit.</th><th>Total</th><th>Data</th>
      </tr></thead><tbody></tbody>`;
      const tb = tbl.querySelector('tbody');
      const lista = pedidos.filter(p=>p.ramo===ramo);
      lista.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.nome}</td>
          <td>${p.email}</td>
          <td>${p.produto}</td>
          <td>${p.tamanho}</td>
          <td>${p.quantidade||0}</td>
          <td>${money(p.precoUnit)}</td>
          <td>${money(p.total)}</td>
          <td>${p.data||''}</td>
        `;
        tb.appendChild(tr);
      });
      secRamos.appendChild(tbl);

      // bind export para cada tabela por ramo
      b1.addEventListener('click', ()=> exportCSV(tbl, 'Pedidos '+ramo));
      b2.addEventListener('click', ()=> exportXLSX(tbl, 'Pedidos '+ramo));
    });

    // ligar botões de export das duas primeiras tabelas
    bindExports('admin-detalhados','admin-detalhados-table','Pedidos detalhados');
    bindExports('admin-por-ramo','admin-por-ramo-table','Pedidos por ramo (agregado)');
  }

  document.getElementById('aplicar-filtro').addEventListener('click', render);
  document.getElementById('limpar-filtro').addEventListener('click', () => {
    document.getElementById('filtro-inicio').value = '';
    document.getElementById('filtro-fim').value = '';
    render();
  });
  window.addEventListener('storage', render);
  window.addEventListener('load', render);
  </script>

</body>
</html>
