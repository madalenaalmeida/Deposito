<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Administração</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;margin:0;background:#f7f8fb;color:#111;}
    header{position:sticky;top:0;background:#0b5cff;color:#fff;padding:16px 20px;z-index:10;box-shadow:0 2px 10px rgba(0,0,0,.08)}
    h1{font-size:20px;margin:0}
    main{padding:20px;max-width:1200px;margin:0 auto}
    section{background:#fff;border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.06);padding:16px 16px;margin:16px 0}
    section>h2{font-size:18px;margin:0 0 12px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width: 1024px){.grid{grid-template-columns:1fr 1fr}}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    thead th{font-size:12px;text-transform:uppercase;letter-spacing:.04em;color:#555;text-align:left;padding:10px 12px}
    tbody td{background:#fafbff;padding:10px 12px;border-top:1px solid #eef1ff;border-bottom:1px solid #eef1ff}
    tbody tr{transition:.15s}
    tbody tr:hover td{background:#f2f5ff}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef1ff}
    .totais{display:flex;gap:16px;flex-wrap:wrap;margin-top:8px;color:#333}
    .muted{color:#666;font-size:12px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    input[type="date"]{padding:8px;border:1px solid #dfe4ff;border-radius:10px}
    button{padding:8px 12px;border:0;border-radius:10px;background:#0b5cff;color:#fff;font-weight:600;cursor:pointer}
    button.secondary{background:#eef1ff;color:#0b5cff}
    .ramo-title{margin:12px 0 6px;font-size:16px}
  </style>
</head>
<body>
  <header><h1>Admin — Pedidos</h1></header>
  <main>
    <section>
      <div class="controls">
        <label>De <input type="date" id="filtro-inicio"></label>
        <label>Até <input type="date" id="filtro-fim"></label>
        <button id="aplicar-filtro" class="secondary">Aplicar filtro</button>
        <button id="limpar-filtro" class="secondary">Limpar</button>
      </div>
      <div class="totais" id="resumo"></div>
    </section>

    <section id="sec-detalhados">
      <h2>Pedidos detalhados (todos)</h2>
      <table id="tabela-detalhada">
        <thead>
          <tr>
            <th>Nome</th><th>Email</th><th>Ramo</th><th>Produto</th><th>Tamanho</th><th>Qtd</th><th>Preço unit.</th><th>Total</th><th>Data</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="sec-por-ramo">
      <h2>Pedidos por ramo (agregado)</h2>
      <table id="tabela-por-ramo">
        <thead>
          <tr>
            <th>Ramo</th><th>Produto</th><th>Tamanho</th><th>Quantidade</th><th>Preço</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="muted">“Preço” é o total (quantidade × preço unitário).</p>
    </section>

    <section id="sec-ramo-detalhes">
      <h2>Por ramo — detalhes</h2>
      <div id="ramos-detalhes"></div>
    </section>
  </main>

  <script>
    function parseMaybeNumber(v){ if(typeof v === 'number') return v; if(!v) return 0; v = String(v).replace(',', '.'); const n = Number(v); return isNaN(n)?0:n; }
    function formatMoney(n){ return (Math.round(n*100)/100).toFixed(2).replace('.', ',') + '€'; }

    function getPedidosRaw(){
      try{
        const arr = JSON.parse(localStorage.getItem('pedidos')) || [];
        return Array.isArray(arr)? arr : [];
      }catch(e){ return []; }
    }

    function normalizePedido(p){
      // Aceita tanto keys EN (branch,product,price,size,quantity) como PT (ramo,produto,preco,tamanho,quantidade)
      return {
        nome: p.nome || p.name || '',
        email: p.email || '',
        ramo: p.ramo || p.branch || '',
        produto: p.produto || p.product || '',
        tamanho: p.tamanho || p.size || '',
        quantidade: parseMaybeNumber(p.quantidade != null ? p.quantidade : p.quantity),
        precoUnit: parseMaybeNumber(p.preco != null ? p.preco : p.price),
        total: parseMaybeNumber(p.preco != null ? p.preco : p.price) * parseMaybeNumber(p.quantidade != null ? p.quantidade : p.quantity),
        data: p.data || p.timestamp || ''
      };
    }

    function filtrarPorData(pedidos, inicio, fim){
      if(!inicio && !fim) return pedidos;
      const i = inicio ? new Date(inicio) : null;
      const f = fim ? new Date(fim) : null;
      return pedidos.filter(p => {
        if(!p.data) return true;
        const d = new Date(p.data);
        if(i && d < i) return false;
        if(f && d > f) return false;
        return true;
      });
    }

    function agrupar(pedidos, chaveFn){
      const map = new Map();
      for(const p of pedidos){
        const k = chaveFn(p);
        const rec = map.get(k) || { quantidade: 0, total: 0, sample: p };
        rec.quantidade += p.quantidade || 0;
        rec.total += p.total || 0;
        map.set(k, rec);
      }
      return Array.from(map.entries()).map(([k,v]) => ({ key:k, ...v }));
    }

    function render(){
      const inicio = document.getElementById('filtro-inicio').value;
      const fim    = document.getElementById('filtro-fim').value;
      const brutos = getPedidosRaw().map(normalizePedido);
      const pedidos = filtrarPorData(brutos, inicio, fim);

      // Resumo
      const totalQtd = pedidos.reduce((s,p)=>s+(p.quantidade||0),0);
      const totalVal = pedidos.reduce((s,p)=>s+(p.total||0),0);
      document.getElementById('resumo').innerHTML = \`
        <span><b>\${pedidos.length}</b> registos</span>
        <span>|</span>
        <span>Quantidade total: <b>\${totalQtd}</b></span>
        <span>|</span>
        <span>Valor total: <b>\${formatMoney(totalVal)}</b></span>
      \`;

      // 1) Detalhados
      const tb1 = document.querySelector('#tabela-detalhada tbody');
      tb1.innerHTML = '';
      for(const p of pedidos){
        const tr = document.createElement('tr');
        tr.innerHTML = \`
          <td>\${p.nome}</td>
          <td>\${p.email}</td>
          <td><span class="pill">\${p.ramo}</span></td>
          <td>\${p.produto}</td>
          <td>\${p.tamanho}</td>
          <td>\${p.quantidade||0}</td>
          <td>\${formatMoney(p.precoUnit)}</td>
          <td>\${formatMoney(p.total)}</td>
          <td>\${p.data || ''}</td>
        \`;
        tb1.appendChild(tr);
      }

      // 2) Por ramo (agregado): ramo | produto | tamanho | quantidade | preço (total)
      const grupos = agrupar(pedidos, p => [p.ramo, p.produto, p.tamanho].join(' | '));
      const tb2 = document.querySelector('#tabela-por-ramo tbody');
      tb2.innerHTML = '';
      for(const g of grupos){
        const [ramo, produto, tamanho] = g.key.split(' | ');
        const tr = document.createElement('tr');
        tr.innerHTML = \`
          <td><span class="pill">\${ramo}</span></td>
          <td>\${produto}</td>
          <td>\${tamanho}</td>
          <td>\${g.quantidade}</td>
          <td>\${formatMoney(g.total)}</td>
        \`;
        tb2.appendChild(tr);
      }

      // 3) Por ramo — tabelas detalhadas
      const porRamo = agrupar(pedidos, p => p.ramo).map(g => ({ ramo: g.key, pedidos: pedidos.filter(p => p.ramo===g.key) }));
      const cont = document.getElementById('ramos-detalhes');
      cont.innerHTML = '';
      for(const sec of porRamo){
        const h = document.createElement('div');
        h.className = 'ramo-title';
        h.innerHTML = '<b>'+sec.ramo+'</b>';
        cont.appendChild(h);
        const tbl = document.createElement('table');
        tbl.innerHTML = \`
          <thead><tr>
            <th>Nome</th><th>Email</th><th>Produto</th><th>Tamanho</th><th>Qtd</th><th>Preço unit.</th><th>Total</th><th>Data</th>
          </tr></thead><tbody></tbody>\`;
        const tb = tbl.querySelector('tbody');
        for(const p of sec.pedidos){
          const tr = document.createElement('tr');
          tr.innerHTML = \`
            <td>\${p.nome}</td>
            <td>\${p.email}</td>
            <td>\${p.produto}</td>
            <td>\${p.tamanho}</td>
            <td>\${p.quantidade||0}</td>
            <td>\${formatMoney(p.precoUnit)}</td>
            <td>\${formatMoney(p.total)}</td>
            <td>\${p.data || ''}</td>
          \`;
          tb.appendChild(tr);
        }
        cont.appendChild(tbl);
      }
    }

    document.getElementById('aplicar-filtro').addEventListener('click', render);
    document.getElementById('limpar-filtro').addEventListener('click', () => {
      document.getElementById('filtro-inicio').value = '';
      document.getElementById('filtro-fim').value = '';
      render();
    });

    window.addEventListener('storage', render);
    window.addEventListener('load', render);
  </script>
</body>
</html>