<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel de Administração</title>
  <!-- Mantém o teu CSS ORIGINAL (não alterei nada) -->
  <link rel="stylesheet" href="admin.css">
  <!-- (Opcional) XLSX para exportação .xlsx; se não quiseres, podes remover e ficas com CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="admin-style.css">
</head>
<body>
  <!-- Cabeçalho/toolbar do teu admin (mantém o estilo do teu admin.css) -->
  <header class="navbar">
    <div class="navbar-inner">
      <h1>Admin — Depósito</h1>
    </div>
  </header>

  <main class="admin-content">
    <!-- Filtros (data) -->
    <section id="admin-filtros" class="controls">
      <label>De <input type="date" id="filtro-inicio"></label>
      <label>Até <input type="date" id="filtro-fim"></label>
      <button id="aplicar-filtro" type="button">Aplicar filtro</button>
      <button id="limpar-filtro" type="button">Limpar</button>
      <span id="admin-resumo"></span>
    </section>

    <!-- Tabelas geradas dinamicamente: mantêm-se dentro de <main> para herdar o teu CSS -->
    <section id="admin-detalhados">
      <h2>Pedidos detalhados (todos)</h2>
      <table id="admin-detalhados-table">
        <thead>
          <tr>
            <th>Nome</th><th>Email</th><th>Ramo</th><th>Produto</th><th>Tamanho</th><th>Qtd</th><th>Preço unit.</th><th>Total</th><th>Data</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="admin-por-ramo">
      <h2>Pedidos por ramo (agregado)</h2>
      <table id="admin-por-ramo-table">
        <thead>
          <tr>
            <th>Ramo</th><th>Produto</th><th>Tamanho</th><th>Quantidade</th><th>Preço (total)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="admin-por-ramo-detalhes">
      <h2>Por ramo — detalhes</h2>
      <!-- Aqui serão inseridas as tabelas de cada ramo -->
    </section>
  </main>

  <!-- ===================== LÓGICA DO ADMIN (EMBUTIDA) ===================== -->
  <script>
  // ===== Helpers =====
  const parseMaybeNumber = (v) => {
    if (typeof v === 'number') return v;
    if (v == null) return 0;
    const n = Number(String(v).replace(',', '.'));
    return isNaN(n) ? 0 : n;
  };
  const money = (n) => (Math.round(n*100)/100).toFixed(2).replace('.', ',') + '€';

  // Normaliza chaves PT/EN vindas do localStorage.pedidos
  const norm = (p) => ({
    nome: p.nome || p.name || '',
    email: p.email || '',
    ramo: p.ramo || p.branch || '',
    produto: p.produto || p.product || '',
    tamanho: p.tamanho || p.size || '',
    quantidade: parseMaybeNumber(p.quantidade != null ? p.quantidade : p.quantity),
    precoUnit: parseMaybeNumber(p.preco != null ? p.preco : p.price),
    total: parseMaybeNumber(p.preco != null ? p.preco : p.price) * parseMaybeNumber(p.quantidade != null ? p.quantidade : p.quantity),
    data: p.data || p.timestamp || ''
  });

  const getPedidos = () => {
    try {
      const arr = JSON.parse(localStorage.getItem('pedidos')) || [];
      return Array.isArray(arr) ? arr.map(norm) : [];
    } catch(e) { return []; }
  };

  const filtrarPorData = (arr, ini, fim) => {
    if (!ini && !fim) return arr;
    const i = ini ? new Date(ini) : null;
    const f = fim ? new Date(fim) : null;
    return arr.filter(p => {
      if (!p.data) return true;
      const d = new Date(p.data);
      if (i && d < i) return false;
      if (f && d > f) return false;
      return true;
    });
  };

  const agrupar = (arr, keyFn) => {
    const map = new Map();
    for (const p of arr) {
      const k = keyFn(p);
      const rec = map.get(k) || { quantidade: 0, total: 0, sample: p };
      rec.quantidade += p.quantidade || 0;
      rec.total += p.total || 0;
      map.set(k, rec);
    }
    return Array.from(map.entries()).map(([key, v]) => ({ key, ...v }));
  };

  // ===== Render Principal =====
  function render(){
    const ini = document.getElementById('filtro-inicio')?.value || '';
    const fim = document.getElementById('filtro-fim')?.value || '';
    const pedidos = filtrarPorData(getPedidos(), ini, fim);

    // Resumo
    const totalQtd = pedidos.reduce((s,p)=>s+(p.quantidade||0),0);
    const totalVal = pedidos.reduce((s,p)=>s+(p.total||0),0);
    const resumo = document.getElementById('admin-resumo');
    if (resumo) resumo.innerHTML = `<b>${pedidos.length}</b> registos | Qtde: <b>${totalQtd}</b> | Valor: <b>${money(totalVal)}</b>`;

    // 1) Detalhados (todos)
    const tbDetalhe = document.querySelector('#admin-detalhados-table tbody');
    tbDetalhe.innerHTML = '';
    pedidos.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.nome}</td>
        <td>${p.email}</td>
        <td>${p.ramo}</td>
        <td>${p.produto}</td>
        <td>${p.tamanho}</td>
        <td>${p.quantidade||0}</td>
        <td>${money(p.precoUnit)}</td>
        <td>${money(p.total)}</td>
        <td>${p.data||''}</td>
      `;
      tbDetalhe.appendChild(tr);
    });

    // 2) Por ramo (agregado)
    const grupos = agrupar(pedidos, p => [p.ramo, p.produto, p.tamanho].join(' | '));
    const tbRamo = document.querySelector('#admin-por-ramo-table tbody');
    tbRamo.innerHTML = '';
    grupos.forEach(g => {
      const [ramo, produto, tamanho] = g.key.split(' | ');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${ramo}</td>
        <td>${produto}</td>
        <td>${tamanho}</td>
        <td>${g.quantidade}</td>
        <td>${money(g.total)}</td>
      `;
      tbRamo.appendChild(tr);
    });

    // 3) Uma tabela por ramo (detalhada)
    const secRamos = document.getElementById('admin-por-ramo-detalhes');
    // limpa tabelas antigas (mas mantém o <h2> da secção)
    Array.from(secRamos.querySelectorAll('table, .ramo-title')).forEach(n => n.remove());
    const rams = Array.from(new Set(pedidos.map(p => p.ramo))).filter(Boolean);
    rams.forEach(ramo => {
      const h = document.createElement('div');
      h.className = 'ramo-title';
      h.textContent = ramo;
      secRamos.appendChild(h);
      const tbl = document.createElement('table');
      tbl.innerHTML = `<thead><tr>
        <th>Nome</th><th>Email</th><th>Produto</th><th>Tamanho</th><th>Qtd</th><th>Preço unit.</th><th>Total</th><th>Data</th>
      </tr></thead><tbody></tbody>`;
      const tb = tbl.querySelector('tbody');
      pedidos.filter(p=>p.ramo===ramo).forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.nome}</td>
          <td>${p.email}</td>
          <td>${p.produto}</td>
          <td>${p.tamanho}</td>
          <td>${p.quantidade||0}</td>
          <td>${money(p.precoUnit)}</td>
          <td>${money(p.total)}</td>
          <td>${p.data||''}</td>
        `;
        tb.appendChild(tr);
      });
      secRamos.appendChild(tbl);
    });
  }

  document.getElementById('aplicar-filtro').addEventListener('click', render);
  document.getElementById('limpar-filtro').addEventListener('click', () => {
    document.getElementById('filtro-inicio').value = '';
    document.getElementById('filtro-fim').value = '';
    render();
  });

  window.addEventListener('storage', render);
  window.addEventListener('load', render);
  </script>

  <!-- ===================== EXPORTAÇÃO (CSV / XLSX) — EMBUTIDO ===================== -->
  <script>
  (function(){
    function slugify(s){
      return (s||'tabela')
        .toString()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g,'-')
        .replace(/(^-|-$)/g,'');
    }
    function toCSV(table){
      const rows = Array.from(table.querySelectorAll('tr')).map(tr =>
        Array.from(tr.querySelectorAll('th,td')).map(td => {
          let txt = (td.innerText||'').replace(/\r?\n|\r/g, ' ').trim();
          if (/[",;\n]/.test(txt)) txt = '"' + txt.replace(/"/g, '""') + '"';
          return txt;
        }).join(';')
      );
      return rows.join('\n');
    }
    function downloadBlob(content, filename, mime){
      const blob = new Blob([content], {type: mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{
        URL.revokeObjectURL(url);
        a.remove();
      }, 0);
    }
    function exportCSV(table){
      const title = table.closest('section')?.querySelector('h2')?.innerText || table.getAttribute('id') || 'tabela';
      const name = slugify(title) + '_' + new Date().toISOString().slice(0,10) + '.csv';
      downloadBlob(toCSV(table), name, 'text/csv;charset=utf-8;');
    }
    function exportXLSX(table){
      if (typeof XLSX === 'undefined' || !XLSX?.utils?.table_to_book) {
        alert('Para exportar em Excel (.xlsx), a biblioteca XLSX já está incluída no <head>. Se removeres essa linha, usa o CSV.');
        return;
      }
      const title = table.closest('section')?.querySelector('h2')?.innerText || table.getAttribute('id') || 'tabela';
      const wb = XLSX.utils.table_to_book(table, {sheet: title.slice(0,31)});
      const name = slugify(title) + '_' + new Date().toISOString().slice(0,10) + '.xlsx';
      XLSX.writeFile(wb, name);
    }
    function addButtons(table){
      if (table.dataset.exportBound === '1') return;
      table.dataset.exportBound = '1';
      const wrap = document.createElement('div');
      wrap.style.margin = '6px 0';
      const btnCSV = document.createElement('button');
      btnCSV.type = 'button';
      btnCSV.textContent = 'Exportar CSV';
      btnCSV.addEventListener('click', ()=>exportCSV(table));
      const btnXLSX = document.createElement('button');
      btnXLSX.type = 'button';
      btnXLSX.textContent = 'Exportar Excel';
      btnXLSX.style.marginLeft = '6px';
      btnXLSX.addEventListener('click', ()=>exportXLSX(table));
      wrap.appendChild(btnCSV);
      wrap.appendChild(btnXLSX);
      table.parentNode.insertBefore(wrap, table);
    }
    function init(){
      const main = document.querySelector('main') || document.body;
      const tables = main.querySelectorAll('table');
      tables.forEach(addButtons);
    }
    window.addEventListener('load', init);
    const mo = new MutationObserver(() => {
      const main = document.querySelector('main') || document.body;
      const tables = main.querySelectorAll('table');
      tables.forEach(addButtons);
    });
    mo.observe(document.documentElement, {childList:true, subtree:true});
  })();
  </script>
</body>
</html>
