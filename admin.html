<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel de Administração</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="admin-style.css">

  <!-- Biblioteca para Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Biblioteca para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<div class="navbar">
  <a href="index.html" class="voltar-inicio">
    <i class="fas fa-arrow-left"></i>
  </a>
  <span class="navbar-text">Painel de Administração</span>
</div>

<div class="container">

  <!-- Tabelas -->
  <section id="admin-detalhados">
    <h2>Pedidos detalhados (todos)</h2>
    <div class="table-actions">
      <button class="btn-pdf" type="button" id="exp-detalhados-pdf">Exportar PDF</button>
      <button class="btn-excel" type="button" id="exp-detalhados-xlsx">Exportar Excel</button>
    </div>
    <table id="admin-detalhados-table">
      <thead>
        <tr>
          <th>Nome</th><th>Email</th><th>Ramo</th><th>Produto</th><th>Tamanho</th><th>Qtd</th><th>Preço unit.</th><th>Total</th><th>Data</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="admin-por-ramo">
    <h2>Pedidos por ramo (agregado)</h2>
    <div class="table-actions">
      <button class="btn-pdf" type="button" id="exp-porramo-pdf">Exportar PDF</button>
      <button class="btn-excel" type="button" id="exp-porramo-xlsx">Exportar Excel</button>
    </div>
    <table id="admin-por-ramo-table">
      <thead>
        <tr>
          <th>Ramo</th><th>Produto</th><th>Tamanho</th><th>Quantidade</th><th>Preço (total)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section id="admin-por-ramo-detalhes">
    <h2>Por ramo — detalhes</h2>
  </section>

  <!-- Filtros no fim -->
  <section id="admin-filtros" class="controls">
    <label>De <input type="date" id="filtro-inicio"></label>
    <label>Até <input type="date" id="filtro-fim"></label>
    <button id="aplicar-filtro" type="button">Aplicar filtro</button>
    <button id="limpar-filtro" type="button">Limpar</button>
    <span id="admin-resumo"></span>
  </section>
</div>

<script>
  const parseMaybeNumber = (v) => {
    if (typeof v === 'number') return v;
    if (v == null) return 0;
    const n = Number(String(v).replace(',', '.'));
    return isNaN(n) ? 0 : n;
  };
  const money = (n) => (Math.round(n*100)/100).toFixed(2).replace('.', ',') + '€';
  const norm = (p) => ({
    nome: p.nome || p.name || '',
    email: p.email || '',
    ramo: p.ramo || p.branch || '',
    produto: p.produto || p.product || '',
    tamanho: p.tamanho || p.size || '',
    quantidade: parseMaybeNumber(p.quantidade != null ? p.quantidade : p.quantity),
    precoUnit: parseMaybeNumber(p.preco != null ? p.preco : p.price),
    total: parseMaybeNumber(p.preco != null ? p.preco : p.price) * parseMaybeNumber(p.quantidade != null ? p.quantidade : p.quantity),
    data: p.data || p.timestamp || ''
  });
  const getPedidos = () => {
    try { const arr = JSON.parse(localStorage.getItem('pedidos')) || []; return Array.isArray(arr)?arr.map(norm):[]; }
    catch(e){ return []; }
  };
  const filtrarPorData = (arr, ini, fim) => {
    if (!ini && !fim) return arr;
    const i = ini ? new Date(ini) : null;
    const f = fim ? new Date(fim) : null;
    return arr.filter(p => {
      if (!p.data) return true;
      const d = new Date(p.data);
      if (i && d < i) return false;
      if (f && d > f) return false;
      return true;
    });
  };
  const agrupar = (arr, keyFn) => {
    const map = new Map();
    for (const p of arr) {
      const k = keyFn(p);
      const rec = map.get(k) || { quantidade: 0, total: 0, sample: p };
      rec.quantidade += p.quantidade || 0;
      rec.total += p.total || 0;
      map.set(k, rec);
    }
    return Array.from(map.entries()).map(([key, v]) => ({ key, ...v }));
  };

  function exportExcel(table, title) {
    const wb = XLSX.utils.table_to_book(table, {sheet: title});
    XLSX.writeFile(wb, title.replace(/\s+/g,'_') + '.xlsx');
  }

  function exportPDF(table, title) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text(title, 14, 10);
    doc.autoTable({ html: table });
    doc.save(title.replace(/\s+/g,'_') + '.pdf');
  }

  function bindExports(sectionId, tableId, titleText){
    const tbl = document.getElementById(tableId);
    document.getElementById('exp-'+sectionId.split('admin-')[1]+'-pdf')?.addEventListener('click', ()=> exportPDF(tbl, titleText));
    document.getElementById('exp-'+sectionId.split('admin-')[1]+'-xlsx')?.addEventListener('click', ()=> exportExcel(tbl, titleText));
  }

  function render(){
    const ini = document.getElementById('filtro-inicio')?.value || '';
    const fim = document.getElementById('filtro-fim')?.value || '';
    const pedidos = filtrarPorData(getPedidos(), ini, fim);

    const totalQtd = pedidos.reduce((s,p)=>s+(p.quantidade||0),0);
    const totalVal = pedidos.reduce((s,p)=>s+(p.total||0),0);
    const resumo = document.getElementById('admin-resumo');
    if (resumo) resumo.innerHTML = `<b>${pedidos.length}</b> registos | Qtde: <b>${totalQtd}</b> | Valor: <b>${money(totalVal)}</b>`;

    const tbDetalhe = document.querySelector('#admin-detalhados-table tbody');
    tbDetalhe.innerHTML = '';
    pedidos.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.nome}</td>
        <td>${p.email}</td>
        <td>${p.ramo}</td>
        <td>${p.produto}</td>
        <td>${p.tamanho}</td>
        <td>${p.quantidade||0}</td>
        <td>${money(p.precoUnit)}</td>
        <td>${money(p.total)}</td>
        <td>${p.data||''}</td>
      `;
      tbDetalhe.appendChild(tr);
    });

    const grupos = agrupar(pedidos, p => [p.ramo, p.produto, p.tamanho].join(' | '));
    const tbRamo = document.querySelector('#admin-por-ramo-table tbody');
    tbRamo.innerHTML = '';
    grupos.forEach(g => {
      const [ramo, produto, tamanho] = g.key.split(' | ');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${ramo}</td>
        <td>${produto}</td>
        <td>${tamanho}</td>
        <td>${g.quantidade}</td>
        <td>${money(g.total)}</td>
      `;
      tbRamo.appendChild(tr);
    });

    const secRamos = document.getElementById('admin-por-ramo-detalhes');
    secRamos.innerHTML = '<h2>Por ramo — detalhes</h2>';
    const rams = Array.from(new Set(pedidos.map(p => p.ramo))).filter(Boolean);
    rams.forEach(ramo => {
      const h = document.createElement('div');
      h.className = 'ramo-title';
      h.textContent = ramo;
      secRamos.appendChild(h);

      const bar = document.createElement('div');
      bar.className = 'table-actions';
      const bPDF = document.createElement('button'); bPDF.type='button'; bPDF.textContent='Exportar PDF'; bPDF.className='btn-pdf';
      const bXLSX = document.createElement('button'); bXLSX.type='button'; bXLSX.textContent='Exportar Excel'; bXLSX.className='btn-excel';
      bar.appendChild(bPDF); bar.appendChild(bXLSX);
      secRamos.appendChild(bar);

      const tbl = document.createElement('table');
      tbl.innerHTML = `<thead><tr>
        <th>Nome</th><th>Email</th><th>Produto</th><th>Tamanho</th><th>Qtd</th><th>Preço unit.</th><th>Total</th><th>Data</th>
      </tr></thead><tbody></tbody>`;
      const tb = tbl.querySelector('tbody');
      const lista = pedidos.filter(p=>p.ramo===ramo);
      lista.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.nome}</td>
          <td>${p.email}</td>
          <td>${p.produto}</td>
          <td>${p.tamanho}</td>
          <td>${p.quantidade||0}</td>
          <td>${money(p.precoUnit)}</td>
          <td>${money(p.total)}</td>
          <td>${p.data||''}</td>
        `;
        tb.appendChild(tr);
      });
      secRamos.appendChild(tbl);

      bPDF.addEventListener('click', ()=> exportPDF(tbl, 'Pedidos '+ramo));
      bXLSX.addEventListener('click', ()=> exportExcel(tbl, 'Pedidos '+ramo));
    });

    bindExports('admin-detalhados','admin-detalhados-table','Pedidos detalhados');
    bindExports('admin-por-ramo','admin-por-ramo-table','Pedidos por ramo (agregado)');
  }

  document.getElementById('aplicar-filtro').addEventListener('click', () => {
    const ini = document.getElementById('filtro-inicio').value || '';
    const fim = document.getElementById('filtro-fim').value || '';

    // Guardar para o index
    localStorage.setItem('dataInicio', ini);
    localStorage.setItem('dataFim', fim);

    render();
    alert('Período definido! Verifique no index.html.');
  });

  document.getElementById('limpar-filtro').addEventListener('click', () => {
    document.getElementById('filtro-inicio').value = '';
    document.getElementById('filtro-fim').value = '';
    localStorage.removeItem('dataInicio');
    localStorage.removeItem('dataFim');
    render();
  });

  window.addEventListener('storage', render);
  window.addEventListener('load', render);
</script>

</body>
</html>
